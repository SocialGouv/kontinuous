runs:
  drop-db:
    retry: 3
    use: socialgouv/kontinuous/plugins/contrib/jobs/drop-db
    if: "{{ or $.with.db $.with.pgAdminSecretRefName $.with.database }}"
    with:
      pgAdminSecretRefName: "{{ $.with.pgAdminSecretRefName }}"
      database: "{{ $.with.database }}"

  delete-namespace:
    checkout: false
    image: bitnami/kubectl:latest
    retry: 3
    user: 1001
    kubernetes: true
    vars:
      NAMESPACE: "{{ $.Values.global.namespace }}"
    run: |
      mkdir -p /tmp/.kube
      echo "$KUBECONFIG" > /tmp/.kube/config
      export KUBECONFIG=/tmp/.kube/config

      if kubectl get namespace "$NAMESPACE">/dev/null 2>&1; then
        kubectl delete namespace "$NAMESPACE" --now=true --wait=false
      fi
