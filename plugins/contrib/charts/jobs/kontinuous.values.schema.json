{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://raw.githubusercontent.com/socialgouv/kontinuous/v1/plugins/contrib/charts/jobs/kontinuous.values.schema.json",
  "title": "Kontinuous jobs helm chart",
  "markdownDescription": "The [jobs chart](https://github.com/SocialGouv/kontinuous/blob/master/plugins/contrib/charts/jobs) provides a way to define de define tasks in your deployment pipeline\n\nðŸ’¡ See [the jobs documentations](https://socialgouv.github.io/kontinuous/#/./advanced/build?id=meta-values-plugin-needs).",
  "type": "object",
  "additionalProperties": false,
  "required": ["runs"],
  "properties": {
    "runs": {
      "type": "object",
      "additionalProperties": {
        "type": "object",
        "additionalProperties": false,
        "properties": {
          "use": {
            "type": "string",
            "enum": [
              "build",
              "build-kaniko",
              "create-db",
              "deactivate",
              "drop-db",
              "pg-restore",
              "psql",
              "seed-db"
            ]
          },
          "image": {
            "type": "string"
          },
          "entrypoint": {
            "description": "Docker image entrypoint arguments",
            "examples": ["['sh', '-c', 'echo 42']"],
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "checkout": {
            "description": "Should the repo be checked-out to build. defaults to true",
            "type": "boolean"
          },
          "~needs": {
            "description": "List of kontinuous dependencies",
            "examples": ["['create-db', 'import-sql', 'anonymize']"],
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "memoryLimit": {
            "description": "Kubernetes max memory for the Job before OOMKill",
            "type": "string"
          },
          "memoryRequest": {
            "description": "Kubernetes memory reservation for the Job",
            "type": "string"
          },
          "cpuLimit": {
            "description": "Kubernetes max cpu for the Job before capping",
            "type": "string"
          },
          "cpuRequest": {
            "description": "Kubernetes cpu reservation for the Job",
            "type": "string"
          },
          "with": { "type": "object", "additionalProperties": true }
        },
        "required": ["use"],
        "if": {
          "properties": {
            "use": {
              "const": "build"
            }
          }
        },
        "then": {
          "description": "Build and register docker image with buildkit",
          "properties": {
            "use": {
              "description": "Build and register docker image with buildkit"
            },
            "with": {
              "$ref": "https://raw.githubusercontent.com/socialgouv/kontinuous/v1/plugins/contrib/jobs/build/use.schema.json#"
            }
          },
          "required": ["with"]
        },
        "else": {
          "if": {
            "properties": {
              "use": {
                "const": "build-kaniko"
              }
            }
          },
          "then": {
            "description": "Build and register docker image with kaniko",
            "properties": {
              "use": {
                "description": "Build and register docker image with kaniko"
              },
              "with": {
                "$ref": "https://raw.githubusercontent.com/socialgouv/kontinuous/v1/plugins/contrib/jobs/build-kaniko/use.schema.json#"
              }
            },
            "required": ["with"]
          },
          "else": {
            "if": {
              "properties": {
                "use": {
                  "const": "create-db"
                }
              }
            },
            "then": {
              "description": "Create a Postgres Database",
              "properties": {
                "use": {
                  "description": "Create a Postgres Database"
                },
                "with": {
                  "$ref": "https://raw.githubusercontent.com/socialgouv/kontinuous/v1/plugins/contrib/jobs/create-db/use.schema.json#"
                }
              },
              "required": ["with"]
            },
            "else": {
              "if": {
                "properties": {
                  "use": {
                    "const": "deactivate"
                  }
                }
              },
              "then": {
                "description": "Destroy namespace and databases",
                "properties": {
                  "use": {
                    "description": "Destroy namespace and databases"
                  },
                  "with": {
                    "$ref": "https://raw.githubusercontent.com/socialgouv/kontinuous/v1/plugins/contrib/jobs/deactivate/use.schema.json#"
                  }
                },
                "required": ["with"]
              },
              "else": {
                "if": {
                  "properties": {
                    "use": {
                      "const": "drop-db"
                    }
                  }
                },
                "then": {
                  "description": "Destroy the database",
                  "properties": {
                    "use": {
                      "description": "Destroy the database"
                    },
                    "with": {
                      "$ref": "https://raw.githubusercontent.com/socialgouv/kontinuous/v1/plugins/contrib/jobs/drop-db/use.schema.json#"
                    }
                  },
                  "required": ["with"]
                },
                "else": {
                  "if": {
                    "properties": {
                      "use": {
                        "const": "pg-restore"
                      }
                    }
                  },
                  "then": {
                    "description": "Restore the database from a backup storage",
                    "properties": {
                      "use": {
                        "description": "Restore the database from a backup storage"
                      },
                      "with": {
                        "$ref": "https://raw.githubusercontent.com/socialgouv/kontinuous/v1/plugins/contrib/jobs/pg-restore/use.schema.json#"
                      }
                    },
                    "required": ["with"]
                  },
                  "else": {
                    "if": {
                      "properties": {
                        "use": {
                          "const": "psql"
                        }
                      }
                    },
                    "then": {
                      "description": "Execute psql commands on the database",
                      "properties": {
                        "use": {
                          "description": "Execute psql commands on the database"
                        },
                        "with": {
                          "$ref": "https://raw.githubusercontent.com/socialgouv/kontinuous/v1/plugins/contrib/jobs/psql/use.schema.json#"
                        }
                      },
                      "required": ["with"]
                    },
                    "else": {
                      "if": {
                        "properties": {
                          "use": {
                            "const": "seed-db"
                          }
                        }
                      },
                      "then": {
                        "description": "Execute a repository .sql on the database",
                        "properties": {
                          "use": {
                            "description": "Execute a repository .sql on the database"
                          },
                          "with": {
                            "$ref": "https://raw.githubusercontent.com/socialgouv/kontinuous/v1/plugins/contrib/jobs/seed-db/use.schema.json#"
                          }
                        },
                        "required": ["with"]
                      },
                      "else": {}
                    }
                  }
                }
              }
            }
          }
        }
      },
      "properties": {}
    }
  }
}
