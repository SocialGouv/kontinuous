{{ if .Values.matomo.cronjob.enabled }}
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  labels:
    component: {{ (or .Values.component .Chart.Name) | lower }}
    application: {{ (or .Values.component .Chart.Name) | lower }}
  name: {{ (or .Values.component .Chart.Name) | lower }}
  namespace: {{ .Values.namespace }}
spec:
  schedule: 0 * * * *
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            component: {{ (or .Values.component .Chart.Name) | lower }}
            application: {{ (or .Values.component .Chart.Name) | lower }}
          name: {{ (or .Values.component .Chart.Name) | lower }}
          namespace: {{ .Values.namespace }}
        spec:
          security_context:
            run_as_user: 1000
            run_as_group: 1000
            fs_group: 1000
            run_as_non_root: true
          restartPolicy: OnFailure
          containers:
            - name: {{ (or .Values.component .Chart.Name) | lower }}-container
              image: node:14-alpine
              security_context:
                allow_privilege_escalation: false
              command:
                - sh
                - "-c"
                - npx @socialgouv/matomo-postgres
              envFrom:
                - secretRef:
                    name: {{ (or .Values.component .Chart.Name) | lower }}-cronjob
              env:
                - name: STARTDATE
                  value: "2019-01-01"
                - name: DEBUG
                  value: "*"
{{ end }}