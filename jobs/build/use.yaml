runs:
  - name: kaniko
    needs: [credentials]
    checkout: true
    action: false
    image: gcr.io/kaniko-project/executor:debug
    # serviceAccountName: kaniko
    user: 0
    entrypoint: ["/busybox/sh","-c"]
    envFrom:
      - secretRef:
          name: "{{ $.with.registrySecretRefName }}"
    run: |
      set -x
      mkdir -p /kaniko/.docker
      echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
      # CI_AUTH=$(echo -n "${CI_REGISTRY_USER}:${CI_REGISTRY_PASSWORD}" | base64)
      # echo "{\"auths\":{\"https://$CI_REGISTRY\":\"$CI_AUTH\"}}" > /kaniko/.docker/config.json
      /kaniko/executor \
        --context=dir:///workspace/{{ or $.with.context "" }} \
        --dockerfile={{ or $.with.dockerfile "Dockerfile" }} \
        --destination=$CI_REGISTRY/{{ or $.with.imageName $.Values.global.imageName }}{{ if $.with.imagePackage }}{{ (print "/" $.with.imagePackage) }}{{ end }}:{{ or $.with.imageTag $.Values.global.imageTag }} \
        --cache=true \
        {{ if $.with.buildArgs -}}
        {{- range $key, $val := $.with.buildArgs -}}
        --build-arg="{{ $key }}={{ $val }}" \
        {{- end -}}
        {{- end -}}